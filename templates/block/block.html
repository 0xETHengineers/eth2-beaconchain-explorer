{{ define "js" }}

  <script type="text/javascript" src="/js/datatables.min.js"></script>
  <script type="text/javascript" src="/js/datatable_input.js"></script>

  <script>
    window.onload = function () {
      setupInfiniteScrollAttestations();
      setupInfiniteScrollTransactions();
    };

    function getInfoElementAttestations (text, color) {
      const att_card = document.createElement('div'); {
        att_card.classList.add('card', 'my-2');
        const att_card_body = document.createElement('div'); {
          att_card_body.classList.add('card-body', 'px-0', 'py-1');
          const att_row = document.createElement('div'); {
            att_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_header = document.createElement('div'); {
              att_header.classList.add('col-md-12', 'text-center');
              const att_innerElement = document.createElement('b'); {
                att_innerElement.style.color = color;
                att_innerElement.innerHTML = text;
              }
              att_header.appendChild(att_innerElement);
            }
            att_row.appendChild(att_header);
          }
          att_card_body.appendChild(att_row);
        }
        att_card.appendChild(att_card_body);
      }
      return att_card;
    }

    function getAttestationElement (element) {
      const att_card = document.createElement('div'); {
        att_card.classList.add('card', 'my-2');
        const att_card_body = document.createElement('div'); {
          att_card_body.classList.add('card-body', 'px-0', 'py-1');
          const att_row = document.createElement('div'); {
            att_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_header = document.createElement('div'); {
              att_header.classList.add('col-md-12', 'text-center');
              const att_innerElement = document.createElement('b'); {
                att_innerElement.innerHTML = 'Attestation ' + element.BlockIndex;
              }
              att_header.appendChild(att_innerElement);
            }
            att_row.appendChild(att_header);
          }
          att_card_body.appendChild(att_row);
          const att_slot_row = document.createElement('div'); {
            att_slot_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_slot_titleElement = document.createElement('div'); {
              att_slot_titleElement.classList.add('col-md-2');
              att_slot_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Slot number to which the validator is attesting">Slot:</span>';
            }
            att_slot_row.appendChild(att_slot_titleElement);
            const att_slot_innerElement = document.createElement('div'); {
              att_slot_innerElement.classList.add('col-md-10');
              att_slot_innerElement.innerHTML = '<a href="/slot/' + element.Slot + '">' + element.Slot + '</a>';
            }
            att_slot_row.appendChild(att_slot_innerElement);
          }
          att_card_body.appendChild(att_slot_row);
          const att_committee_row = document.createElement('div'); {
            att_committee_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_committee_titleElement = document.createElement('div'); {
              att_committee_titleElement.classList.add('col-md-2');
              att_committee_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="An identifier for a specific committee during a slot">Committee Index:</span>';
            }
            att_committee_row.appendChild(att_committee_titleElement);
            const att_committee_innerElement = document.createElement('div'); {
              att_committee_innerElement.classList.add('col-md-10');
              att_committee_innerElement.innerHTML = element.CommitteeIndex;
            }
            att_committee_row.appendChild(att_committee_innerElement);
          }
          att_card_body.appendChild(att_committee_row);
          const att_aggregationbits_row = document.createElement('div'); {
            att_aggregationbits_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_aggregationbits_titleElement = document.createElement('div'); {
              att_aggregationbits_titleElement.classList.add('col-md-2');
              att_aggregationbits_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Represents the aggregated attestation of all participating validators in this attestation">Aggregation Bits:</span>';
            }
            att_aggregationbits_row.appendChild(att_aggregationbits_titleElement);
            const att_aggregationbits_innerElement = document.createElement('div'); {
              att_aggregationbits_innerElement.classList.add('col-md-10');
              att_aggregationbits_innerElement.innerHTML = element.AggregationBits;
            }
            att_aggregationbits_row.appendChild(att_aggregationbits_innerElement);
          }
          att_card_body.appendChild(att_aggregationbits_row);
          const att_validator_row = document.createElement('div'); {
            att_validator_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_validator_titleElement = document.createElement('div'); {
              att_validator_titleElement.classList.add('col-md-2');
              att_validator_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Validators who have submitted their attestation and have been included by the block proposer">Validators:</span>';
            }
            att_validator_row.appendChild(att_validator_titleElement);
            const att_validator_innerElement = document.createElement('div'); {
              att_validator_innerElement.classList.add('col-md-10');
              att_validator_innerElement.innerHTML = element.Validators;
            }
            att_validator_row.appendChild(att_validator_innerElement);
          }
          att_card_body.appendChild(att_validator_row);
          const att_beaconblockroot_row = document.createElement('div'); {
            att_beaconblockroot_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_beaconblockroot_titleElement = document.createElement('div'); {
              att_beaconblockroot_titleElement.classList.add('col-md-2');
              att_beaconblockroot_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Points to the block to which validators are attesting">Beacon Block Root:</span>';
            }
            att_beaconblockroot_row.appendChild(att_beaconblockroot_titleElement);
            const att_beaconblockroot_innerElement = document.createElement('div'); {
              att_beaconblockroot_innerElement.classList.add('col-md-10', 'text-monospace', 'text-break');
              att_beaconblockroot_innerElement.innerHTML = '<a href="/slot/' + element.BeaconBlockRoot + '">0x' + element.BeaconBlockRoot + '</a>';
            }
            att_beaconblockroot_row.appendChild(att_beaconblockroot_innerElement);
          }
          att_card_body.appendChild(att_beaconblockroot_row);
          const att_sourceepoch_row = document.createElement('div'); {
            att_sourceepoch_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_sourceepoch_titleElement = document.createElement('div'); {
              att_sourceepoch_titleElement.classList.add('col-md-2');
              att_sourceepoch_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Points to the latest justified epoch">Source:</span>';
            }
            att_sourceepoch_row.appendChild(att_sourceepoch_titleElement);
            const att_sourceepoch_innerElement = document.createElement('div'); {
              att_sourceepoch_innerElement.classList.add('col-md-10');
              att_sourceepoch_innerElement.innerHTML = 'Epoch <a href="/epoch/' + element.SourceEpoch + '">' + element.SourceEpoch + '</a> (<span class="text-monospace text-break"><a href="' + element.SourceRoot + '">0x' + element.SourceRoot + '</a>)</span>';
            }
            att_sourceepoch_row.appendChild(att_sourceepoch_innerElement);
          }
          att_card_body.appendChild(att_sourceepoch_row);
          const att_targetepoch_row = document.createElement('div'); {
            att_targetepoch_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_targetepoch_titleElement = document.createElement('div'); {
              att_targetepoch_titleElement.classList.add('col-md-2');
              att_targetepoch_titleElement.innerHTML = '<span data-toggle="tooltip" data-placement="top" title="Points to the latest epoch boundary">Target:</span>';
            }
            att_targetepoch_row.appendChild(att_targetepoch_titleElement);
            const att_targetepoch_innerElement = document.createElement('div'); {
              att_targetepoch_innerElement.classList.add('col-md-10');
              att_targetepoch_innerElement.innerHTML = 'Epoch <a href="/epoch/' + element.TargetEpoch + '">' + element.TargetEpoch + '</a> (<span class="text-monospace text-break"><a href="' + element.TargetRoot + '">0x' + element.TargetRoot + '</a>)</span>';
            }
            att_targetepoch_row.appendChild(att_targetepoch_innerElement);
          }
          att_card_body.appendChild(att_targetepoch_row);
          const att_signature_row = document.createElement('div'); {
            att_signature_row.classList.add('row', 'border-bottom', 'p-1', 'mx-0');
            const att_signature_titleElement = document.createElement('div'); {
              att_signature_titleElement.classList.add('col-md-2');
              att_signature_titleElement.innerHTML = 'Signature:';
            }
            att_signature_row.appendChild(att_signature_titleElement);
            const att_signature_innerElement = document.createElement('div'); {
              att_signature_innerElement.classList.add('col-md-10', 'text-monospace', 'text-break');
              att_signature_innerElement.innerHTML = '0x' + element.Signature;
            }
            att_signature_row.appendChild(att_signature_innerElement);
          }
          att_card_body.appendChild(att_signature_row);
        }
        att_card.appendChild(att_card_body);
      }
      return att_card;
    }

    async function setupInfiniteScrollAttestations() {
      const infLoading = document.getElementById('attestations');
      if(infLoading) {
        try {
          const res = await fetch(`/slot/${encodeURI({{.Slot}})}/attestations`);
          const data = await res.json();

          for (let i = 1; i < data.length; ++i) {
            infLoading.appendChild(getAttestationElement(data[i]));
          }
        } catch (err) {
          console.error('error getting lazy attestations: ', err)
          infLoading.appendChild(getInfoElementAttestations('Error loading attestations...', 'red'));
        }
      }
    }

    function getInfoElementTransactions (text, color) {
      const txn_tr = document.createElement('tr'); {
        txn_tr.classList.add('border-bottom');
        const txn_td = document.createElement('td'); {
          txn_td.classList.add('border-0');
          txn_td.colSpan = '7';
          txn_td.style.color = color;
          txn_td.style.textAlign = 'center';
          txn_td.style.fontWeight = 'bold';
          txn_td.innerHTML = text;
        }
        txn_tr.appendChild(txn_td);
      }
      return txn_tr;
    }

    function getTransactionsElement(element) {
      const txn_tr = document.createElement('tr'); {
        txn_tr.classList.add('border-bottom');
        const txn_td_HashFormatted = document.createElement('td'); {
          txn_td_HashFormatted.classList.add('border-0');
          txn_td_HashFormatted.innerHTML = element.HashFormatted;
        }
        txn_tr.appendChild(txn_td_HashFormatted);
        const txn_td_Method = document.createElement('td'); {
          txn_td_Method.classList.add('border-0');
          txn_td_Method.innerHTML = element.Method;
        }
        txn_tr.appendChild(txn_td_Method);
        const txn_td_FromFormatted = document.createElement('td'); {
          txn_td_FromFormatted.classList.add('border-0');
          txn_td_FromFormatted.innerHTML = element.FromFormatted;
        }
        txn_tr.appendChild(txn_td_FromFormatted);
        const txn_td_ToFormatted = document.createElement('td'); {
          txn_td_ToFormatted.classList.add('border-0');
          txn_td_ToFormatted.innerHTML = element.ToFormatted;
        }
        txn_tr.appendChild(txn_td_ToFormatted);
        const txn_td_Value = document.createElement('td'); {
          txn_td_Value.classList.add('border-0');
          txn_td_Value.innerHTML = element.Value;
        }
        txn_tr.appendChild(txn_td_Value);
        const txn_td_Fee = document.createElement('td'); {
          txn_td_Fee.classList.add('border-0');
          txn_td_Fee.innerHTML = element.Fee;
        }
        txn_tr.appendChild(txn_td_Fee);
        const txn_td_GasPrice = document.createElement('td'); {
          txn_td_GasPrice.classList.add('border-0');
          txn_td_GasPrice.innerHTML = element.GasPrice;
        }
        txn_tr.appendChild(txn_td_GasPrice);
      }
      return txn_tr;
    }

    async function setupInfiniteScrollTransactions() {
      const infLoading = document.getElementById('transactions_table');
      if(infLoading) {
        try {
          const res = await fetch(`/block/${encodeURI({{.ExecutionData.Number}})}/transactions`);
          const data = await res.json();

          console.log('got data: ', data)

          for (let i = 10; i < data.length; ++i) {
            infLoading.appendChild(getTransactionsElement(data[i]));
          }
        } catch (err) {
          console.error('error getting lazy attestations: ', err)
          infLoading.appendChild(getInfoElementTransactions('Error loading transactions...', 'red'));
        }
      }
    }

    $(document).ready(function () {
      let slotNumber = {{ .Slot }}
      var depositsTblOpts = {
        processing: true,
        serverSide: true,
        ordering: false,
        searching: false,
        ajax: "/slot/" + slotNumber + "/deposits",
        pageLength: 10,
        pagingType: "input",
        language: {
          searchPlaceholder: "Deposit Number / Public Key / Credentials",
          search: "",
          paginate: {
            previous: '<i class="fas fa-chevron-left"></i>',
            next: '<i class="fas fa-chevron-right"></i>',
          },
        },
        columnDefs: [
          {
            targets: 3,
            render: function (data, type, row) {
              return `<div class="d-flex justify-content-between">${data}<i class="fa fa-copy text-muted p-1" role="button" data-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="${data}"></i></div>`
            },
          },
          {
            targets: 4,
            render: function (data, type, row) {
              return `<div class="d-flex"><div data-toggle="tooltip" title="${data}" style="max-width: 130px;" class="text-truncate">${data}</div><i class="fa fa-copy text-muted p-1" role="button" data-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="${data}"></i></div>`
            },
          },
        ],
        preDrawCallback: function () {
          // this does not always work.. not sure how to solve the staying tooltip
          try {
            $("#block_deposits").find('[data-toggle="tooltip"]').tooltip("dispose")
          } catch (e) {
            console.error(e)
          }
        },
        drawCallback: function (settings) {
          formatTimestamps()
          $("#block_deposits").find('[data-toggle="tooltip"]').tooltip()
        },
      }
      let usp = new URLSearchParams(window.location.search)
      let q = usp.get("q")

      if (q) {
        depositsTblOpts.search = { search: q }
      }

      $("#block_deposits").DataTable(depositsTblOpts)

      let votesTblOpts = {
        processing: true,
        serverSide: true,
        ordering: false,
        stateSave: true,
        searching: true,
        ajax: "/slot/" + slotNumber + "/votes",
        pageLength: 10,
        pagingType: "input",
        language: {
          searchPlaceholder: "Validator",
          search: "",
          paginate: {
            previous: '<i class="fas fa-chevron-left"></i>',
            next: '<i class="fas fa-chevron-right"></i>',
          },
        },
        columnDefs: [{ targets: [3], className: "white-space-normal" }],
        preDrawCallback: function () {
          // this does not always work.. not sure how to solve the staying tooltip
          try {
            $("#block_votes").find('[data-toggle="tooltip"]').tooltip("dispose")
          } catch (e) {
            console.error(e)
          }
        },
        drawCallback: function (settings) {
          formatTimestamps()
          $("#block_votes").find('[data-toggle="tooltip"]').tooltip()
        },
      }

      if (q) {
        votesTblOpts.search = { search: q }
      }

      $("#block_votes").DataTable(votesTblOpts)
    })
  </script>

  <script>
    viewHexDataAs("graffiti", "utf-8")
    viewHexDataAs("extra-data", "utf-8")
  </script>
{{ end }}

{{ define "css" }}
  <link rel="stylesheet" type="text/css" href="/css/datatables.min.css" />
{{ end }}

{{ define "content" }}
  {{ with .Data }}
    {{ $isBlockView := (contains $.Meta.Path "block") }}
    <div class="container mt-2">
      <div class="d-md-flex py-2 justify-content-md-between">
        <h1 class="h4 my-3 mb-md-0">
          {{ if $isBlockView }}
            {{ with .ExecutionData }}
              {{ if gt .PreviousBlock 0 }}
                <a href="/block/{{ .PreviousBlock }}"><i class="fa fa-chevron-left"></i></a>
              {{ end }}
              <span class="ml-1 mr-1"><i class="fas fa-cube mr-2"></i>Block {{ .Number }}</span>
              {{ if gt .NextBlock 0 }}
                <a href="/block/{{ .NextBlock }}"><i class="fa fa-chevron-right"></i></a>
              {{ end }}
            {{ end }}
          {{ else }}
            {{ if not (eq .Slot 0) }}
              <a href="/slot/{{ .PreviousSlot }}"><i class="fa fa-chevron-left"></i></a>
            {{ end }}
            <span class="ml-1 mr-1"><i class="fas fa-cube mr-2"></i>Slot <span id="slot">{{ formatAddCommas .Slot }}</span></span>
            {{ if gt .NextSlot 0 }}
              <a href="/slot/{{ .NextSlot }}"><i class="fa fa-chevron-right"></i></a>
            {{ end }}
          {{ end }}
        </h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb font-size-1 mb-0" style="padding: 0; background-color: transparent;">
            <li class="breadcrumb-item"><a href="/" title="Home">Home</a></li>
            <li class="breadcrumb-item"><a href="/slots" title="Slots">Slots</a></li>
            <li class="breadcrumb-item active" aria-current="page">Slot details</li>
          </ol>
        </nav>
      </div>
      {{ if ne (len .Tags) 0 }}
        <div class="tags">
          {{ range .Tags }}
            <a class="user-select-none mb-2 mr-1 px-2 py-2 badge badge-primary shadow-sm text-white" {{ if .Color }}style="background-color: {{ .Color }};"{{ end }} data-toggle="tooltip" data-placement="bottom" title="{{ .Summary }}" {{ if .PublicLink }}href="{{ .PublicLink }}" target="_blank" rel="noopener noreferrer"{{ end }}>
              {{ .Name }}
              <i class="fas fa-info-circle pl-1"></i>
              {{ if .PublicLink }}
                <i class="fas fa-link"></i>
              {{ end }}
            </a>
          {{ end }}
        </div>
      {{ end }}
      <ul style="margin-bottom: -1px; " class="nav nav-tabs justify-content-start" id="tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="true">Overview</a>
        </li>
        {{ with .ExecutionData }}
          <li class="nav-item">
            <a class="nav-link" id="transactions-tab" data-toggle="tab" href="#transactions" role="tab" aria-controls="transactions" aria-selected="false">Transactions <span class="badge bg-secondary text-white">{{ .TxCount }}</span></a>
          </li>
        {{ end }}
        <li class="nav-item">
          <a class="nav-link" id="votes-tab" data-toggle="tab" href="#votes" role="tab" aria-controls="votes" aria-selected="false">Votes <span class="badge bg-secondary text-white">{{ .VotesCount }}</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="attestations-tab" data-toggle="tab" href="#attestations" role="tab" aria-controls="attestations" aria-selected="false">Attestations <span class="badge bg-secondary text-white">{{ .AttestationsCount }}</span></a>
        </li>
        {{ if gt .DepositsCount 0 }}
          <li class="nav-item">
            <a class="nav-link" id="deposits-tab" data-toggle="tab" href="#deposits" role="tab" aria-controls="deposits" aria-selected="false">Deposits <span class="badge bg-secondary text-white">{{ .DepositsCount }}</span></a>
          </li>
        {{ end }}
        {{ if gt .VoluntaryExitscount 0 }}
          <li class="nav-item">
            <a class="nav-link" id="voluntary-exits-tab" data-toggle="tab" href="#voluntary-exits" role="tab" aria-controls="voluntary-exits" aria-selected="false">Voluntary Exits <span class="badge bg-secondary text-white">{{ .VoluntaryExitscount }}</span></a>
          </li>
        {{ end }}
        {{ if gt .AttesterSlashingsCount 0 }}
          <li class="nav-item">
            <a class="nav-link" id="attester-slashings-tab" data-toggle="tab" href="#attester-slashings" role="tab" aria-controls="attester-slashings" aria-selected="false">Attester Slashings <span class="badge bg-secondary text-white">{{ .AttesterSlashingsCount }}</span></a>
          </li>
        {{ end }}
        {{ if gt .ProposerSlashingsCount 0 }}
          <li class="nav-item">
            <a class="nav-link" id="proposer-slashings-tab" data-toggle="tab" href="#proposer-slashings" role="tab" aria-controls="proposer-slashings" aria-selected="false">Proposer Slashings <span class="badge bg-secondary text-white">{{ .ProposerSlashingsCount }}</span></a>
          </li>
        {{ end }}
      </ul>
      <style>
        .block-card {
          border-top-left-radius: 0;
          border-top-right-radius: 0;
        }
      </style>
      <div class="tab-content" id="tabContent">
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
          <div class="card block-card">
            {{ template "block_overview" $ }}
          </div>
        </div>
        {{ if gt .VotesCount 0 }}
          <div class="tab-pane fade" id="votes" role="tabpanel" aria-labelledby="votes-tab">
            <div class="card block-card">
              {{ template "block_votes" . }}
            </div>
          </div>
        {{ end }}
        <div class="tab-pane fade" id="attestations" role="tabpanel" aria-labelledby="attestations-tab">
          <div class="card block-card">
            <div style="margin-bottom: -.25rem;" class="card-body px-0 py-1">
              <div class="row p-1 mx-0">
                <h3 class="h5 col-md-12 text-center"><b>Showing {{ .AttestationsCount }} Attestations </b></h3>
              </div>
            </div>
          </div>
          {{ template "block_attestations" . }}
        </div>
        {{ if .ExecutionData }}
          <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
            <div class="card block-card py-1">
              {{ template "execution_transactions" .ExecutionData }}
            </div>
          </div>
        {{ end }}
        {{ if gt .DepositsCount 0 }}
          <div class="tab-pane fade" id="deposits" role="tabpanel" aria-labelledby="deposits-tab">
            <div class="card block-card">
              {{ template "block_deposits" . }}
            </div>
          </div>
        {{ end }}
        {{ if gt .VoluntaryExitscount 0 }}
          <div class="tab-pane fade" id="voluntary-exits" role="tabpanel" aria-labelledby="voluntary-exits-tab">
            <div class="card block-card">
              {{ template "block_exits" . }}
            </div>
          </div>
        {{ end }}
        {{ if gt .AttesterSlashingsCount 0 }}
          <!-- Nav tabs -->
          <div class="tab-pane fade" id="attester-slashings" role="tabpanel" aria-labelledby="attester-slashings-tab">
            <div class="card block-card">
              <div style="margin-bottom: -.25rem;" class="card-body px-0 py-1">
                <div class="row p-1 mx-0">
                  <h3 class="h5 col-md-12 text-center"><b>Showing {{ .AttesterSlashingsCount }} Attester Slashing(s) </b></h3>
                </div>
              </div>
            </div>
            {{ template "block_attesterSlashing" . }}
          </div>
        {{ end }}
        {{ if gt .ProposerSlashingsCount 0 }}
          <div class="tab-pane fade" id="proposer-slashings" role="tabpanel" aria-labelledby="proposer-slashings-tab">
            <div class="card block-card">
              <div style="margin-bottom: -.25rem;" class="card-body px-0 py-1">
                <div class="row p-1 mx-0">
                  <h3 class="h5 col-md-12 text-center"><b>Showing {{ .ProposerSlashingsCount }} Proposer Slashing(s) </b></h3>
                </div>
              </div>
            </div>
            {{ template "block_proposerSlashing" . }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
{{ end }}
